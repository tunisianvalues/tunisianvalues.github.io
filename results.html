<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TunisianValues — Résultats</title>
    <link rel="icon" type="image/png" href="icon.svg" />
    <link
      href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { oswald: ["Oswald", "sans-serif"] },
          },
        },
      };
    </script>
    <style>
      .bar-shadow {
        filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.4));
      }
      input[type="range"].slider-input {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 9999px;
        outline: none;
        opacity: 0.8;
        transition: opacity 0.2s;
      }
      input[type="range"].slider-input:hover {
        opacity: 1;
      }
      input[type="range"].slider-input::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: #dc2626;
        cursor: pointer;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      }
      input[type="range"].slider-input::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: #dc2626;
        cursor: pointer;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>
  <body class="font-oswald antialiased">
    <div class="min-h-screen bg-gradient-to-br from-red-600 to-red-700">
      <header class="border-b border-red-500/30 bg-red-600/90 backdrop-blur-sm">
        <div class="container mx-auto px-4 py-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <img
                src="TUNISIAN VALUES.png"
                alt="TunisianValues logo"
                class="h-10 w-auto"
              />
            </div>
            <div class="flex items-center gap-4">
              <a
                href="https://discord.gg/3HyBH7y23Z"
                target="_blank"
                rel="noopener noreferrer"
                class="text-white/80 hover:text-white transition-colors"
                ><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"
                  /></svg
              ></a>
            </div>
          </div>
        </div>
      </header>
      <main class="container mx-auto px-4 py-12">
        <div
          id="results-container"
          class="max-w-4xl mx-auto bg-white/95 backdrop-blur-sm rounded-xl p-6 md:p-8 shadow-2xl"
        >
          <div class="text-center mb-10">
            <h1 class="text-5xl font-bold text-red-700">Vos Résultats</h1>
            <p class="text-lg text-slate-600 mt-2">
              Votre profil politique le plus proche est :
              <span id="ideology-label" class="font-bold text-red-600"
                >Calcul en cours...</span
              >
            </p>
          </div>

          <div class="space-y-6">
            <!-- Barres de résultats pour chaque axe -->
            <div>
              <h3 class="text-xl font-bold text-gray-800 mb-2">
                Axe Panarabisme
              </h3>
              <div class="flex justify-between items-baseline mb-1 text-sm">
                <span class="font-bold text-red-600">Unité Arabe</span
                ><span class="font-bold text-slate-700">Nationalisme</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-6 shadow-inner">
                <div class="flex h-full rounded-full">
                  <div
                    id="bar-left-pana"
                    style="background-color: #c52a2a"
                    class="flex items-center justify-center text-white text-sm font-bold rounded-l-full pb-0.5"
                  >
                    <span id="left-pana"></span>
                  </div>
                  <div
                    id="bar-neutral-pana"
                    style="background-color: #eeeeee"
                    class="flex items-center justify-center text-black text-sm font-bold pb-0.5"
                  >
                    <span id="neutral-pana"></span>
                  </div>
                  <div
                    id="bar-right-pana"
                    style="background-color: #4b5563"
                    class="flex items-center justify-center text-white text-sm font-bold rounded-r-full pb-0.5"
                  >
                    <span id="right-pana"></span>
                  </div>
                </div>
              </div>
            </div>
            <div>
              <h3 class="text-xl font-bold text-gray-800 mb-2">
                Axe Coopération
              </h3>
              <div class="flex justify-between items-baseline mb-1 text-sm">
                <span class="font-bold text-orange-600">Internationalisme</span
                ><span class="font-bold text-blue-600">Isolationnisme</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-6 shadow-inner">
                <div class="flex h-full rounded-full">
                  <div
                    id="bar-left-coop"
                    style="background-color: #ea580c"
                    class="flex items-center justify-center text-white text-sm font-bold rounded-l-full pb-0.5"
                  >
                    <span id="left-coop"></span>
                  </div>
                  <div
                    id="bar-neutral-coop"
                    style="background-color: #eeeeee"
                    class="flex items-center justify-center text-black text-sm font-bold pb-0.5"
                  >
                    <span id="neutral-coop"></span>
                  </div>
                  <div
                    id="bar-right-coop"
                    style="background-color: #3b82f6"
                    class="flex items-center justify-center text-white text-sm font-bold rounded-r-full pb-0.5"
                  >
                    <span id="right-coop"></span>
                  </div>
                </div>
              </div>
            </div>
            <div>
              <h3 class="text-xl font-bold text-gray-800 mb-2">Axe Économie</h3>
              <div class="flex justify-between items-baseline mb-1 text-sm">
                <span class="font-bold text-red-600">Socialisme</span
                ><span class="font-bold text-green-600">Capitalisme</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-6 shadow-inner">
                <div class="flex h-full rounded-full">
                  <div
                    id="bar-left-econ"
                    style="background-color: #c52a2a"
                    class="flex items-center justify-center text-white text-sm font-bold rounded-l-full pb-0.5"
                  >
                    <span id="left-econ"></span>
                  </div>
                  <div
                    id="bar-neutral-econ"
                    style="background-color: #eeeeee"
                    class="flex items-center justify-center text-black text-sm font-bold pb-0.5"
                  >
                    <span id="neutral-econ"></span>
                  </div>
                  <div
                    id="bar-right-econ"
                    style="background-color: #16a34a"
                    class="flex items-center justify-center text-white text-sm font-bold rounded-r-full pb-0.5"
                  >
                    <span id="right-econ"></span>
                  </div>
                </div>
              </div>
            </div>
            <div>
              <h3 class="text-xl font-bold text-gray-800 mb-2">Axe Religion</h3>
              <div class="flex justify-between items-baseline mb-1 text-sm">
                <span class="font-bold text-emerald-600">Islam Politique</span
                ><span class="font-bold text-purple-600">Laïcisme</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-6 shadow-inner">
                <div class="flex h-full rounded-full">
                  <div
                    id="bar-left-reli"
                    style="background-color: #059669"
                    class="flex items-center justify-center text-white text-sm font-bold rounded-l-full pb-0.5"
                  >
                    <span id="left-reli"></span>
                  </div>
                  <div
                    id="bar-neutral-reli"
                    style="background-color: #eeeeee"
                    class="flex items-center justify-center text-black text-sm font-bold pb-0.5"
                  >
                    <span id="neutral-reli"></span>
                  </div>
                  <div
                    id="bar-right-reli"
                    style="background-color: #9333ea"
                    class="flex items-center justify-center text-white text-sm font-bold rounded-r-full pb-0.5"
                  >
                    <span id="right-reli"></span>
                  </div>
                </div>
              </div>
            </div>
            <div>
              <h3 class="text-xl font-bold text-gray-800 mb-2">Axe Sociétal</h3>
              <div class="flex justify-between items-baseline mb-1 text-sm">
                <span class="font-bold text-amber-600">Conservatisme</span
                ><span class="font-bold text-pink-600">Progressisme</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-6 shadow-inner">
                <div class="flex h-full rounded-full">
                  <div
                    id="bar-left-soci"
                    style="background-color: #d97706"
                    class="flex items-center justify-center text-white text-sm font-bold rounded-l-full pb-0.5"
                  >
                    <span id="left-soci"></span>
                  </div>
                  <div
                    id="bar-neutral-soci"
                    style="background-color: #eeeeee"
                    class="flex items-center justify-center text-black text-sm font-bold pb-0.5"
                  >
                    <span id="neutral-soci"></span>
                  </div>
                  <div
                    id="bar-right-soci"
                    style="background-color: #db2777"
                    class="flex items-center justify-center text-white text-sm font-bold rounded-r-full pb-0.5"
                  >
                    <span id="right-soci"></span>
                  </div>
                </div>
              </div>
            </div>
            <div>
              <h3 class="text-xl font-bold text-gray-800 mb-2">
                Axe Démocratie
              </h3>
              <div class="flex justify-between items-baseline mb-1 text-sm">
                <span class="font-bold text-blue-600">Démocratie</span
                ><span class="font-bold text-red-700">Autoritarisme</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-6 shadow-inner">
                <div class="flex h-full rounded-full">
                  <div
                    id="bar-left-demo"
                    style="background-color: #2563eb"
                    class="flex items-center justify-center text-white text-sm font-bold rounded-l-full pb-0.5"
                  >
                    <span id="left-demo"></span>
                  </div>
                  <div
                    id="bar-neutral-demo"
                    style="background-color: #eeeeee"
                    class="flex items-center justify-center text-black text-sm font-bold pb-0.5"
                  >
                    <span id="neutral-demo"></span>
                  </div>
                  <div
                    id="bar-right-demo"
                    style="background-color: #c52a2a"
                    class="flex items-center justify-center text-white text-sm font-bold rounded-r-full pb-0.5"
                  >
                    <span id="right-demo"></span>
                  </div>
                </div>
              </div>
            </div>
            <div>
              <h3 class="text-xl font-bold text-gray-800 mb-2">
                Axe Gouvernance
              </h3>
              <div class="flex justify-between items-baseline mb-1 text-sm">
                <span class="font-bold text-indigo-600">Décentralisation</span
                ><span class="font-bold text-slate-600">Centralisation</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-6 shadow-inner">
                <div class="flex h-full rounded-full">
                  <div
                    id="bar-left-decent"
                    style="background-color: #4f46e5"
                    class="flex items-center justify-center text-white text-sm font-bold rounded-l-full pb-0.5"
                  >
                    <span id="left-decent"></span>
                  </div>
                  <div
                    id="bar-neutral-decent"
                    style="background-color: #eeeeee"
                    class="flex items-center justify-center text-black text-sm font-bold pb-0.5"
                  >
                    <span id="neutral-decent"></span>
                  </div>
                  <div
                    id="bar-right-decent"
                    style="background-color: #64748b"
                    class="flex items-center justify-center text-white text-sm font-bold rounded-r-full pb-0.5"
                  >
                    <span id="right-decent"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="special-icons-container" class="text-center mt-10"></div>

          <div class="border-t-2 border-gray-200 mt-10 pt-6 space-y-4">
            <div>
              <button
                id="toggle-refinement"
                class="w-full flex justify-between items-center text-left py-2 px-1"
              >
                <span class="text-xl font-bold text-gray-800"
                  >Affiner votre profil et vos priorités</span
                >
                <svg
                  id="refinement-arrow"
                  class="w-6 h-6 transition-transform text-red-600"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="3"
                    d="M19 9l-7 7-7-7"
                  />
                </svg>
              </button>
              <div
                id="refinement-content"
                class="hidden mt-4 p-6 bg-gray-100/80 rounded-xl border border-gray-200 overflow-hidden"
              >
                <p class="text-center text-slate-600 mb-8 max-w-2xl mx-auto">
                  Attribuez une importance à chaque axe politique pour obtenir
                  un classement qui reflète vos priorités.
                </p>
                <div id="weights-container" class="space-y-5"></div>
                <div class="text-center mt-8">
                  <button
                    id="recalculate-button"
                    class="bg-red-600 hover:bg-red-700 text-white font-bold text-lg px-8 py-3 rounded-lg transition-all duration-300 hover:shadow-lg transform hover:-translate-y-0.5"
                  >
                    Recalculer le classement
                  </button>
                </div>
              </div>
            </div>
            <div>
              <button
                id="toggle-ranking"
                class="w-full flex justify-between items-center text-left py-2 px-1"
              >
                <span class="text-xl font-bold text-gray-800"
                  >Voir le classement de proximité détaillé</span
                >
                <svg
                  id="ranking-arrow"
                  class="w-6 h-6 transition-transform text-red-600"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="3"
                    d="M19 9l-7 7-7-7"
                  />
                </svg>
              </button>
              <div
                id="ranking-content"
                class="hidden mt-4 p-6 bg-gray-100/80 rounded-xl border border-gray-200 overflow-hidden"
              ></div>
            </div>
          </div>

          <div
            class="mt-12 text-center flex flex-col sm:flex-row justify-center items-center gap-4"
          >
            <button
              id="download-button"
              onclick="downloadResults();"
              class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold text-lg px-8 py-3 rounded-lg transition-colors shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
            >
              Télécharger les Résultats
            </button>
            <button
              onclick="location.href='quiz.html';"
              class="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-bold text-lg px-8 py-3 rounded-lg transition-colors shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
            >
              Refaire le Quiz
            </button>
          </div>
        </div>
      </main>
    </div>

    <div
      id="share-card-container"
      class="fixed top-0 z-[-1]"
      style="left: -9999px; width: 1080px; height: 1350px"
    >
      <style>
        #share-card .bar-value {
          text-shadow: 0px 1px 4px rgba(0, 0, 0, 0.7);
        }
      </style>
      <div
        id="share-card"
        class="w-full h-full p-12 flex flex-col justify-center font-oswald relative text-white bg-zinc-900"
        style="
          font-family: 'Oswald', sans-serif;
          background-image: radial-gradient(
            circle at top,
            rgba(153, 27, 27, 0.4),
            transparent 70%
          );
        "
      >
        <header class="text-center border-b-2 border-white/20 pb-6 mb-10">
          <img
            src="TUNISIAN VALUES.png"
            alt="Logo"
            class="h-24 w-auto mx-auto mb-4"
          />
          <h1
            class="text-6xl font-bold uppercase tracking-widest"
            style="text-shadow: 0 0 15px rgba(255, 50, 50, 0.5)"
          >
            Mes Résultats
          </h1>
          <h2 class="text-4xl font-light text-white/80 mt-2">
            Profil le plus proche :
            <span id="share-ideology" class="font-bold text-red-400"></span>
          </h2>
        </header>
        <main
          class="w-full max-w-2xl mx-auto flex flex-col justify-center space-y-7 my-4"
        >
          <div class="axis-item">
            <div class="flex justify-between items-baseline mb-1 text-xl">
              <span class="font-semibold text-white/80">Unité Arabe</span
              ><span class="font-semibold text-white/80">Nationalisme</span>
            </div>
            <div
              class="w-full bg-black/40 rounded-full h-8 shadow-inner bar-shadow"
            >
              <div
                class="flex rounded-full h-full text-base font-bold items-center"
              >
                <div
                  id="share-bar-left-pana"
                  class="bg-gradient-to-r from-red-500 to-red-600 rounded-l-full h-full flex items-center justify-center pl-2"
                >
                  <span id="share-val-left-pana" class="bar-value"></span>
                </div>
                <div
                  id="share-bar-neutral-pana"
                  class="bg-gray-500/50 h-full flex items-center justify-center"
                >
                  <span id="share-val-neutral-pana" class="bar-value"></span>
                </div>
                <div
                  id="share-bar-right-pana"
                  class="bg-gradient-to-l from-slate-600 to-slate-700 rounded-r-full h-full flex items-center justify-center pr-2"
                >
                  <span id="share-val-right-pana" class="bar-value"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="axis-item">
            <div class="flex justify-between items-baseline mb-1 text-xl">
              <span class="font-semibold text-white/80">Internationalisme</span
              ><span class="font-semibold text-white/80">Isolationnisme</span>
            </div>
            <div
              class="w-full bg-black/40 rounded-full h-8 shadow-inner bar-shadow"
            >
              <div
                class="flex rounded-full h-full text-base font-bold items-center"
              >
                <div
                  id="share-bar-left-coop"
                  class="bg-gradient-to-r from-orange-400 to-orange-500 rounded-l-full h-full flex items-center justify-center pl-2"
                >
                  <span id="share-val-left-coop" class="bar-value"></span>
                </div>
                <div
                  id="share-bar-neutral-coop"
                  class="bg-gray-500/50 h-full flex items-center justify-center"
                >
                  <span id="share-val-neutral-coop" class="bar-value"></span>
                </div>
                <div
                  id="share-bar-right-coop"
                  class="bg-gradient-to-l from-sky-500 to-sky-600 rounded-r-full h-full flex items-center justify-center pr-2"
                >
                  <span id="share-val-right-coop" class="bar-value"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="axis-item">
            <div class="flex justify-between items-baseline mb-1 text-xl">
              <span class="font-semibold text-white/80">Socialisme</span
              ><span class="font-semibold text-white/80">Capitalisme</span>
            </div>
            <div
              class="w-full bg-black/40 rounded-full h-8 shadow-inner bar-shadow"
            >
              <div
                class="flex rounded-full h-full text-base font-bold items-center"
              >
                <div
                  id="share-bar-left-econ"
                  class="bg-gradient-to-r from-red-500 to-red-600 rounded-l-full h-full flex items-center justify-center pl-2"
                >
                  <span id="share-val-left-econ" class="bar-value"></span>
                </div>
                <div
                  id="share-bar-neutral-econ"
                  class="bg-gray-500/50 h-full flex items-center justify-center"
                >
                  <span id="share-val-neutral-econ" class="bar-value"></span>
                </div>
                <div
                  id="share-bar-right-econ"
                  class="bg-gradient-to-l from-green-500 to-green-600 rounded-r-full h-full flex items-center justify-center pr-2"
                >
                  <span id="share-val-right-econ" class="bar-value"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="axis-item">
            <div class="flex justify-between items-baseline mb-1 text-xl">
              <span class="font-semibold text-white/80">Islam Politique</span
              ><span class="font-semibold text-white/80">Laïcisme</span>
            </div>
            <div
              class="w-full bg-black/40 rounded-full h-8 shadow-inner bar-shadow"
            >
              <div
                class="flex rounded-full h-full text-base font-bold items-center"
              >
                <div
                  id="share-bar-left-reli"
                  class="bg-gradient-to-r from-emerald-500 to-emerald-600 rounded-l-full h-full flex items-center justify-center pl-2"
                >
                  <span id="share-val-left-reli" class="bar-value"></span>
                </div>
                <div
                  id="share-bar-neutral-reli"
                  class="bg-gray-500/50 h-full flex items-center justify-center"
                >
                  <span id="share-val-neutral-reli" class="bar-value"></span>
                </div>
                <div
                  id="share-bar-right-reli"
                  class="bg-gradient-to-l from-purple-500 to-purple-600 rounded-r-full h-full flex items-center justify-center pr-2"
                >
                  <span id="share-val-right-reli" class="bar-value"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="axis-item">
            <div class="flex justify-between items-baseline mb-1 text-xl">
              <span class="font-semibold text-white/80">Conservatisme</span
              ><span class="font-semibold text-white/80">Progressisme</span>
            </div>
            <div
              class="w-full bg-black/40 rounded-full h-8 shadow-inner bar-shadow"
            >
              <div
                class="flex rounded-full h-full text-base font-bold items-center"
              >
                <div
                  id="share-bar-left-soci"
                  class="bg-gradient-to-r from-amber-500 to-amber-600 rounded-l-full h-full flex items-center justify-center pl-2"
                >
                  <span id="share-val-left-soci" class="bar-value"></span>
                </div>
                <div
                  id="share-bar-neutral-soci"
                  class="bg-gray-500/50 h-full flex items-center justify-center"
                >
                  <span id="share-val-neutral-soci" class="bar-value"></span>
                </div>
                <div
                  id="share-bar-right-soci"
                  class="bg-gradient-to-l from-pink-500 to-pink-600 rounded-r-full h-full flex items-center justify-center pr-2"
                >
                  <span id="share-val-right-soci" class="bar-value"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="axis-item">
            <div class="flex justify-between items-baseline mb-1 text-xl">
              <span class="font-semibold text-white/80">Démocratie</span
              ><span class="font-semibold text-white/80">Autoritarisme</span>
            </div>
            <div
              class="w-full bg-black/40 rounded-full h-8 shadow-inner bar-shadow"
            >
              <div
                class="flex rounded-full h-full text-base font-bold items-center"
              >
                <div
                  id="share-bar-left-demo"
                  class="bg-gradient-to-r from-sky-500 to-sky-600 rounded-l-full h-full flex items-center justify-center pl-2"
                >
                  <span id="share-val-left-demo" class="bar-value"></span>
                </div>
                <div
                  id="share-bar-neutral-demo"
                  class="bg-gray-500/50 h-full flex items-center justify-center"
                >
                  <span id="share-val-neutral-demo" class="bar-value"></span>
                </div>
                <div
                  id="share-bar-right-demo"
                  class="bg-gradient-to-l from-red-500 to-red-600 rounded-r-full h-full flex items-center justify-center pr-2"
                >
                  <span id="share-val-right-demo" class="bar-value"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="axis-item">
            <div class="flex justify-between items-baseline mb-1 text-xl">
              <span class="font-semibold text-white/80">Décentralisation</span
              ><span class="font-semibold text-white/80">Centralisation</span>
            </div>
            <div
              class="w-full bg-black/40 rounded-full h-8 shadow-inner bar-shadow"
            >
              <div
                class="flex rounded-full h-full text-base font-bold items-center"
              >
                <div
                  id="share-bar-left-decent"
                  class="bg-gradient-to-r from-indigo-500 to-indigo-600 rounded-l-full h-full flex items-center justify-center pl-2"
                >
                  <span id="share-val-left-decent" class="bar-value"></span>
                </div>
                <div
                  id="share-bar-neutral-decent"
                  class="bg-gray-500/50 h-full flex items-center justify-center"
                >
                  <span id="share-val-neutral-decent" class="bar-value"></span>
                </div>
                <div
                  id="share-bar-right-decent"
                  class="bg-gradient-to-l from-slate-500 to-slate-600 rounded-r-full h-full flex items-center justify-center pr-2"
                >
                  <span id="share-val-right-decent" class="bar-value"></span>
                </div>
              </div>
            </div>
          </div>
        </main>
        <footer class="text-center mt-10">
          <div id="share-special-icons-wrapper" class="mb-4">
            <h3 class="font-bold text-xl uppercase text-red-300">
              Positions Notables
            </h3>
            <div
              id="share-special-icons"
              class="flex gap-4 justify-center flex-wrap mt-3 h-16 items-center"
            ></div>
          </div>
          <p class="text-2xl text-white/70 font-semibold">
            Faites le test sur
            <span class="font-bold text-white tracking-wider"
              >tunisianvalues.github.io</span
            >
          </p>
        </footer>
      </div>
    </div>

    <script>
      const ideologies = [
        {
          name: "Ennahdha",
          stats: {
            pana: { left: 45, neutral: 20, right: 35 },
            coop: { left: 70, neutral: 20, right: 10 },
            econ: { left: 40, neutral: 20, right: 40 },
            reli: { left: 85, neutral: 10, right: 5 },
            soci: { left: 85, neutral: 10, right: 5 },
            demo: { left: 50, neutral: 20, right: 30 },
            decent: { left: 40, neutral: 30, right: 20 },
          },
          weights: {
            pana: 1.5,
            coop: 1,
            econ: 2,
            reli: 5,
            soci: 5,
            demo: 1,
            decent: 1,
          },
        },
        {
          name: "Parti Destourien Libre (PDL)",
          stats: {
            pana: { left: 35, neutral: 0, right: 65 },
            coop: { left: 25, neutral: 10, right: 65 },
            econ: { left: 45, neutral: 5, right: 40 },
            reli: { left: 10, neutral: 15, right: 75 },
            soci: { left: 70, neutral: 10, right: 20 },
            demo: { left: 10, neutral: 15, right: 75 },
            decent: { left: 15, neutral: 10, right: 75 },
          },
          weights: {
            pana: 3,
            coop: 2,
            econ: 1,
            reli: 3,
            soci: 2,
            demo: 3,
            decent: 2,
          },
        },
        {
          name: "Mouvement Echaâb",
          stats: {
            pana: { left: 70, neutral: 20, right: 10 },
            coop: { left: 25, neutral: 0, right: 65 },
            econ: { left: 65, neutral: 10, right: 15 },
            reli: { left: 10, neutral: 20, right: 70 },
            soci: { left: 70, neutral: 10, right: 20 },
            demo: { left: 15, neutral: 25, right: 60 },
            decent: { left: 20, neutral: 10, right: 70 },
          },
          weights: {
            pana: 3,
            coop: 1,
            econ: 2,
            reli: 3,
            soci: 3,
            demo: 3,
            decent: 1,
          },
        },
        {
          name: "Afek Tounes",
          stats: {
            pana: { left: 20, neutral: 20, right: 60 },
            coop: { left: 80, neutral: 0, right: 20 },
            econ: { left: 25, neutral: 15, right: 60 },
            reli: { left: 5, neutral: 25, right: 70 },
            soci: { left: 5, neutral: 15, right: 80 },
            demo: { left: 85, neutral: 10, right: 5 },
            decent: { left: 40, neutral: 30, right: 30 },
          },
          weights: {
            pana: 1,
            coop: 2,
            econ: 3,
            reli: 2,
            soci: 2,
            demo: 3,
            decent: 1,
          },
        },
        {
          name: "Parti des Travailleurs",
          stats: {
            pana: { left: 40, neutral: 20, right: 40 },
            coop: { left: 40, neutral: 20, right: 40 },
            econ: { left: 85, neutral: 10, right: 0 },
            reli: { left: 5, neutral: 5, right: 90 },
            soci: { left: 5, neutral: 10, right: 85 },
            demo: { left: 50, neutral: 30, right: 20 },
            decent: { left: 35, neutral: 30, right: 35 },
          },
          weights: {
            pana: 1,
            coop: 1,
            econ: 3,
            reli: 3,
            soci: 3,
            demo: 2,
            decent: 1,
          },
        },
        {
          name: "Coalition Al Karama",
          stats: {
            pana: { left: 70, neutral: 20, right: 10 },
            coop: { left: 25, neutral: 10, right: 65 },
            econ: { left: 40, neutral: 20, right: 40 },
            reli: { left: 95, neutral: 5, right: 0 },
            soci: { left: 95, neutral: 5, right: 0 },
            demo: { left: 20, neutral: 10, right: 70 },
            decent: { left: 15, neutral: 15, right: 70 },
          },
          weights: {
            pana: 2,
            coop: 1,
            econ: 0.5,
            reli: 3,
            soci: 3,
            demo: 3,
            decent: 1,
          },
        },
        {
          name: "Courant Démocrate (Attayar)",
          stats: {
            pana: { left: 35, neutral: 10, right: 55 },
            coop: { left: 75, neutral: 20, right: 5 },
            econ: { left: 70, neutral: 5, right: 25 },
            reli: { left: 15, neutral: 25, right: 60 },
            soci: { left: 20, neutral: 30, right: 50 },
            demo: { left: 70, neutral: 10, right: 20 },
            decent: { left: 55, neutral: 10, right: 35 },
          },
          weights: {
            pana: 1,
            coop: 2,
            econ: 3,
            reli: 2,
            soci: 2,
            demo: 3,
            decent: 1,
          },
        },
        {
          name: "Parti Baath Tunisien",
          stats: {
            pana: { left: 95, neutral: 5, right: 0 },
            coop: { left: 20, neutral: 5, right: 75 },
            econ: { left: 70, neutral: 20, right: 10 },
            reli: { left: 15, neutral: 20, right: 65 },
            soci: { left: 60, neutral: 20, right: 20 },
            demo: { left: 5, neutral: 10, right: 85 },
            decent: { left: 5, neutral: 5, right: 90 },
          },
          weights: {
            pana: 3,
            coop: 2,
            econ: 1,
            reli: 1,
            soci: 1,
            demo: 3,
            decent: 2,
          },
        },
        {
          name: "Ettakatol (FDTL)",
          stats: {
            pana: { left: 25, neutral: 45, right: 30 },
            coop: { left: 70, neutral: 5, right: 25 },
            econ: { left: 45, neutral: 10, right: 45 },
            reli: { left: 10, neutral: 20, right: 70 },
            soci: { left: 25, neutral: 15, right: 60 },
            demo: { left: 85, neutral: 10, right: 5 },
            decent: { left: 40, neutral: 30, right: 30 },
          },
          weights: {
            pana: 1,
            coop: 2,
            econ: 2,
            reli: 3,
            soci: 2,
            demo: 3,
            decent: 1,
          },
        },
        {
          name: "Al Joumhouri",
          stats: {
            pana: { left: 20, neutral: 50, right: 30 },
            coop: { left: 60, neutral: 10, right: 30 },
            econ: { left: 30, neutral: 10, right: 55 },
            reli: { left: 15, neutral: 25, right: 60 },
            soci: { left: 25, neutral: 35, right: 40 },
            demo: { left: 70, neutral: 15, right: 15 },
            decent: { left: 55, neutral: 25, right: 20 },
          },
          weights: {
            pana: 1,
            coop: 1,
            econ: 3,
            reli: 2,
            soci: 2,
            demo: 3,
            decent: 1,
          },
        },
          {
          name: "Processus du 25-Juillet (Parti Politique)",
          stats: {
            pana: { left: 40, neutral: 5, right: 55 },
            coop: { left: 30, neutral: 10, right: 60 },
            econ: { left: 30, neutral: 10, right: 55 },
            reli: { left: 40, neutral: 20, right: 40 },
            soci: { left: 60, neutral: 10, right: 30 },
            demo: { left: 25, neutral: 10, right: 65 },
            decent: { left: 55, neutral: 5, right: 40 },
          },
          weights: {
            pana: 2,
            coop: 2,
            econ: 1,
            reli: 1,
            soci: 3,
            demo: 3,
            decent: 2,
          },
        },
      ];

      const axes = ["pana", "coop", "econ", "reli", "soci", "demo", "decent"];
      const final_pct = {};
      let total_neutral_score = 0,
        total_max_score = 0;

      function getQueryVariable(variable) {
        const query = window.location.search.substring(1);
        const vars = query.split("&");
        for (let i = 0; i < vars.length; i++) {
          const pair = vars[i].split("=");
          if (decodeURIComponent(pair[0]) == variable) {
            return variable === "icons"
              ? decodeURIComponent(pair[1])
              : parseFloat(decodeURIComponent(pair[1]));
          }
        }
        return null;
      }

      function updateUserIdeology() {
        const averageNeutrality =
          total_max_score > 0
            ? (total_neutral_score / total_max_score) * 100
            : 100;
        const NEUTRALITY_THRESHOLD = 60.0;
        const rankingContainer = document.getElementById("ranking-content");

        if (averageNeutrality >= NEUTRALITY_THRESHOLD) {
          const undeterminedProfile =
            "Profil Indéterminé (trop de réponses neutres)";
          document.getElementById("ideology-label").innerHTML =
            undeterminedProfile;
          document.getElementById("share-ideology").innerHTML = "Indéterminé";
          rankingContainer.innerHTML = `<h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Classement de Proximité</h2><p class="text-center text-slate-700">Le classement ne peut être calculé car votre profil est indéterminé.</p>`;
          return;
        }

        const userWeights = {};
        axes.forEach((axis) => {
          userWeights[axis] = parseInt(
            document.getElementById(`weight-${axis}`).value,
            10
          );
        });

        let partyScores = [];
        for (const party of ideologies) {
          let dist = 0;
          axes.forEach((axis) => {
            const user_axis = final_pct[axis],
              ideology_axis = party.stats[axis];
            if (!ideology_axis) return;
            const axis_dist =
              Math.pow(user_axis.left - ideology_axis.left, 2) +
              Math.pow(user_axis.neutral - ideology_axis.neutral, 2) +
              Math.pow(user_axis.right - ideology_axis.right, 2);
            dist += axis_dist * (party.weights[axis] || 1) * userWeights[axis];
          });
          partyScores.push({ name: party.name, distance: dist });
        }

        partyScores.sort((a, b) => a.distance - b.distance);

        const MAX_DISTANCE_CEILING = 450000;
        const rankedParties = partyScores.map((party) => ({
          name: party.name,
          compatibility: Math.max(
            0,
            Math.round(100 * (1 - party.distance / MAX_DISTANCE_CEILING))
          ),
        }));

        const topProfile = rankedParties[0];
        document.getElementById(
          "ideology-label"
        ).innerHTML = `${topProfile.name} (${topProfile.compatibility}%)`;
        document.getElementById("share-ideology").innerHTML = topProfile.name;

        let rankingHTML = `<h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Classement de Proximité</h2><div class="space-y-4">`;
        const top5Parties = rankedParties.slice(0, 5);
        top5Parties.forEach((party) => {
          rankingHTML += `<div><div class="flex justify-between items-center mb-1"><span class="font-bold text-gray-700">${party.name}</span><span class="font-semibold text-red-600">${party.compatibility}%</span></div><div class="w-full bg-gray-200 rounded-full h-4 shadow-inner"><div class="bg-gradient-to-r from-red-500 to-red-700 h-4 rounded-full transition-all duration-500" style="width: ${party.compatibility}%;"></div></div></div>`;
        });
        rankingHTML += `</div>`;
        rankingContainer.innerHTML = rankingHTML;
      }

      window.onload = function () {
        axes.forEach((axis) => {
          const s = getQueryVariable("s_" + axis) || 0,
            n = getQueryVariable("n_" + axis) || 0,
            m = getQueryVariable("m_" + axis) || 0;
          total_neutral_score += n;
          total_max_score += m;
          let neutral = 0,
            left = 0,
            right = 0;
          if (m > 0) {
            neutral = (n / m) * 100;
            const decided_max = m - n;
            if (decided_max > 0) {
              const decided_pct = 100 - neutral;
              const norm_s = (s + decided_max) / (2 * decided_max);
              left = norm_s * decided_pct;
              right = (1 - norm_s) * decided_pct;
            }
          } else {
            neutral = 100;
          }
          final_pct[axis] = { left, neutral, right };
          document.getElementById(`bar-left-${axis}`).style.width = `${left}%`;
          document.getElementById(
            `bar-neutral-${axis}`
          ).style.width = `${neutral}%`;
          document.getElementById(
            `bar-right-${axis}`
          ).style.width = `${right}%`;
          if (left > 12)
            document.getElementById(`left-${axis}`).innerText = `${Math.round(
              left
            )}%`;
          if (neutral > 12)
            document.getElementById(
              `neutral-${axis}`
            ).innerText = `${Math.round(neutral)}%`;
          if (right > 12)
            document.getElementById(`right-${axis}`).innerText = `${Math.round(
              right
            )}%`;
          document.getElementById(
            `share-bar-left-${axis}`
          ).style.width = `${left}%`;
          document.getElementById(
            `share-bar-neutral-${axis}`
          ).style.width = `${neutral}%`;
          document.getElementById(
            `share-bar-right-${axis}`
          ).style.width = `${right}%`;
          if (left > 10)
            document.getElementById(
              `share-val-left-${axis}`
            ).innerText = `${Math.round(left)}%`;
          if (neutral > 10)
            document.getElementById(
              `share-val-neutral-${axis}`
            ).innerText = `${Math.round(neutral)}%`;
          if (right > 10)
            document.getElementById(
              `share-val-right-${axis}`
            ).innerText = `${Math.round(right)}%`;
        });

        const axes_labels = {
          pana: "Panarabisme",
          coop: "Coopération",
          econ: "Économie",
          reli: "Religion",
          soci: "Sociétal",
          demo: "Démocratie",
          decent: "Gouvernance",
        };
        const weightsContainer = document.getElementById("weights-container");
        axes.forEach((axis) => {
          weightsContainer.innerHTML += `<div class="grid grid-cols-1 sm:grid-cols-3 items-center gap-2 sm:gap-4"><label for="weight-${axis}" class="font-bold text-gray-800 text-center sm:text-left">${axes_labels[axis]}</label><div class="col-span-2 flex items-center gap-3"><span class="text-sm text-gray-500">Peu important</span><input type="range" id="weight-${axis}" min="1" max="5" value="3" class="slider-input w-full cursor-pointer"><span class="text-sm text-gray-500">Très important</span></div></div>`;
        });

        updateUserIdeology();
        document
          .getElementById("recalculate-button")
          .addEventListener("click", updateUserIdeology);

        const icons_param = getQueryVariable("icons");
        if (icons_param && icons_param.length > 0) {
          const container = document.getElementById("special-icons-container"),
            shareIconContainer = document.getElementById("share-special-icons"),
            icons = icons_param.split(",");
          const title = document.createElement("h3");
          title.innerText = "Positions Particulières";
          title.className = "text-2xl font-bold text-gray-800 mb-4";
          container.appendChild(title);
          const iconWrapper = document.createElement("div");
          iconWrapper.className =
            "flex justify-center items-center gap-4 flex-wrap";
          container.appendChild(iconWrapper);
          icons.forEach((iconId) => {
            if (iconId) {
              const img = document.createElement("img");
              img.src = `icons/${iconId}.png`;
              img.title = iconId;
              img.className =
                "h-20 w-20 object-contain transition-transform hover:scale-110";
              iconWrapper.appendChild(img);
              const shareImg = img.cloneNode(true);
              shareImg.className = "h-16 w-16 object-contain";
              shareIconContainer.appendChild(shareImg);
            }
          });
        }

        const toggleRefinementBtn =
          document.getElementById("toggle-refinement");
        const refinementContent = document.getElementById("refinement-content");
        const refinementArrow = document.getElementById("refinement-arrow");
        toggleRefinementBtn.addEventListener("click", () => {
          refinementContent.classList.toggle("hidden");
          refinementArrow.classList.toggle("rotate-180");
        });

        const toggleRankingBtn = document.getElementById("toggle-ranking");
        const rankingContent = document.getElementById("ranking-content");
        const rankingArrow = document.getElementById("ranking-arrow");
        toggleRankingBtn.addEventListener("click", () => {
          rankingContent.classList.toggle("hidden");
          rankingArrow.classList.toggle("rotate-180");
        });
      };

      async function imageToBase64(imgElement) {
        try {
          if (!imgElement.src || imgElement.src.startsWith("data:")) {
            return imgElement.src;
          }
          const response = await fetch(imgElement.src);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const blob = await response.blob();
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          });
        } catch (error) {
          console.error(
            `Impossible de charger l'image ${imgElement.src}:`,
            error
          );
          return null;
        }
      }

      async function downloadResults() {
        const downloadButton = document.getElementById("download-button");
        downloadButton.disabled = true;
        downloadButton.innerText = "Génération en cours...";
        const card = document.getElementById("share-card");
        const imagesToConvert = Array.from(card.getElementsByTagName("img"));
        try {
          await document.fonts.ready;
          await Promise.all(
            imagesToConvert.map(async (img) => {
              const base64Src = await imageToBase64(img);
              if (base64Src) {
                img.src = base64Src;
              }
            })
          );
          const canvas = await html2canvas(card, {
            scale: 2,
            useCORS: true,
            width: 1080,
            height: 1350,
            logging: false,
            backgroundColor: "#18181B",
          });
          const link = document.createElement("a");
          link.download = "Mes-Resultats-TunisianValues.png";
          link.href = canvas.toDataURL("image/png");
          link.click();
        } catch (err) {
          console.error("Erreur lors de la génération de l'image:", err);
          alert(
            "Désolé, une erreur est survenue lors de la création de l'image. Veuillez réessayer."
          );
        } finally {
          downloadButton.disabled = false;
          downloadButton.innerText = "Télécharger les Résultats";
        }
      }
    </script>
  </body>
</html>
